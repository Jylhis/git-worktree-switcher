#!/usr/bin/env bash

# AUTOCOMPLETION FOR BASH
# Reference: https://www.gnu.org/software/bash/manual/html_node/A-Programmable-Completion-Example.html

_wt() {
    local cur prev
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"
    COMPREPLY=()

    # Subcommands and options
    local subcommands="list add remove help version init -i"

    # First argument: subcommands, options, or worktree names
    if [[ ${COMP_CWORD} -eq 1 ]]; then
        local IFS=$'\n'
        local suggestions

        if [[ ${cur} == -* ]]; then
            # Complete options
            COMPREPLY=($(compgen -W "-i" -- "$cur"))
        else
            # Complete subcommands and worktree names
            local worktrees
            worktrees=$(wt list 2>/dev/null)
            suggestions=$(compgen -W "$subcommands $worktrees" -- "$cur")
            for word in $suggestions; do
                COMPREPLY+=("$(printf '%q' "$word")")
            done
        fi
        return
    fi

    # Context-aware completion for second argument
    case "$prev" in
        add)
            # Complete with git branch names for 'add' command
            if git rev-parse --git-dir &>/dev/null; then
                local branches
                branches=$(git for-each-ref --format='%(refname:short)' refs/heads/ refs/remotes/ refs/tags/ 2>/dev/null)
                COMPREPLY=($(compgen -W "$branches" -- "$cur"))
            fi
            ;;
        remove)
            # Complete with worktree names and --force flag
            local IFS=$'\n'
            local worktrees
            worktrees=$(wt list 2>/dev/null)
            COMPREPLY=($(compgen -W "$worktrees --force" -- "$cur"))
            ;;
        init)
            # Complete with supported shell names
            COMPREPLY=($(compgen -W "bash zsh fish" -- "$cur"))
            ;;
    esac
}

# complete
#   -F: take function as completion provider
#   _wt: name of the function
#   wt: name of the command this completion is meant for
complete -F _wt wt
