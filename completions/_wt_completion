#compdef wt

# AUTOCOMPLETION FOR ZSH
# Reference: https://zsh.sourceforge.io/Doc/Release/Completion-System.html

_wt() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    _arguments -C \
        '1: :->command' \
        '2: :->arg2' \
        '*: :->args'

    case $state in
        command)
            local -a subcommands
            subcommands=(
                'list:list all git worktree names'
                'add:create a new worktree'
                'remove:remove an existing worktree'
                'help:show help message'
                'version:show CLI version'
                'init:print init script for shell'
                '-i:interactive mode with fzf'
            )

            # Get worktree names
            local -a worktrees
            if git rev-parse --git-dir &>/dev/null; then
                worktrees=("${(@f)$(wt list 2>/dev/null)}")
            fi

            _alternative \
                'subcommands:subcommand:((${subcommands}))' \
                'worktrees:worktree:compadd -Q -a worktrees'
            ;;
        arg2)
            case $line[1] in
                add)
                    # Complete with git branches, remotes, and tags
                    if git rev-parse --git-dir &>/dev/null; then
                        local -a refs
                        refs=(${(f)"$(git for-each-ref --format='%(refname:short)' refs/heads/ refs/remotes/ refs/tags/ 2>/dev/null)"})
                        _describe -t refs 'branch/tag' refs
                    fi
                    ;;
                remove)
                    # Complete with worktree names
                    if git rev-parse --git-dir &>/dev/null; then
                        local -a worktrees
                        worktrees=("${(@f)$(wt list 2>/dev/null)}")
                        compadd -Q -a worktrees
                    fi
                    ;;
                init)
                    local -a shells
                    shells=(
                        'bash:Bash shell'
                        'zsh:Zsh shell'
                        'fish:Fish shell'
                    )
                    _describe -t shells 'shell' shells
                    ;;
            esac
            ;;
        args)
            # Handle additional arguments for commands
            case $line[1] in
                remove)
                    # Complete with --force flag
                    local -a flags
                    flags=('--force:force removal even if worktree is dirty')
                    _describe -t flags 'flag' flags
                    ;;
            esac
            ;;
    esac
}

_wt "$@"
