# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a git worktree switcher - a bash script called `wt` that enables fast switching between git worktrees and creating new worktrees. This is a fork that includes dynamic Fish completions, special character handling in completions, and a convenient `add` command for creating worktrees.

## Architecture

### Core Script (`wt`)

The main executable is a single bash script at `./wt` with no dependencies beyond git, bash, and fzf (optional, for interactive mode).

**Key architectural patterns:**

1. **Shell Function Wrapper Pattern**: The script doesn't change directories directly. Instead, it outputs a special prefix (`changedir:`) that shell wrapper functions (generated by `wt init <shell>`) parse to perform the actual directory change. This allows the script to work without creating a new shell instance.

2. **Version Management**: VERSION constant is hardcoded at wt:8 and must be manually updated. The version in `package.nix:11` must also be kept in sync. The release workflow (`.github/workflows/release.yml`) validates that the version in the script matches the git tag before releasing.

3. **Worktree Discovery**: Uses `git worktree list --porcelain` to find worktrees, then parses with awk to extract paths or basenames.

4. **Worktree Creation**: The `add_worktree()` function (wt:45-116) creates new worktrees in the parent directory of the main repository. It intelligently handles:
   - Using current branch as source if none specified
   - Checking out existing branches/tags vs creating new branches
   - Validating paths and preventing duplicates
   - Providing clear feedback about what was created

### Shell Completions (`completions/`)

- **Bash** (`wt_completion`): Uses `complete -F` with dynamic completion via `$(wt list)`
- **Zsh** (`_wt_completion`): Uses associative arrays with `compadd -Qa`

All completions dynamically call `wt list` to get current worktree names, supporting spaces and special characters through proper quoting.

### Release Process

Releases are triggered by pushing tags matching `*.*.*-fork` pattern. The workflow:
1. Validates version in script matches git tag
2. Generates changelog from git commits between tags
3. Publishes release with `wt` script and all completion files

## Development Commands

### Testing the Script

```bash
# Run the script directly
./wt help
./wt version
./wt list

# Test worktree switching (requires being in a git repo with worktrees)
./wt <worktree-name>
./wt -i  # Interactive mode (requires fzf)

# Test worktree creation
./wt add feature-name              # Create from current branch
./wt add bugfix main              # Create from existing branch
./wt add newfeature HEAD          # Create new branch from HEAD
```

### Building with Nix

```bash
# Build the package
nix-build -E 'with import <nixpkgs> {}; callPackage ./package.nix {}'

# Install in user environment
nix-env -f package.nix -i

# Build and run
nix-build package.nix && ./result/bin/wt help
```

### Version Management

When updating the version:
1. Update VERSION variable in `wt` script (line 7)
2. Create git tag matching the version: `git tag <version>-fork`
3. Push tag to trigger release: `git push origin <version>-fork`

The release workflow automatically validates version consistency.

### Testing Completions

```bash
# Bash
source completions/wt_completion
# Then test: wt <TAB>

# Zsh
fpath=(completions $fpath)
autoload -Uz compinit && compinit
# Then test: wt <TAB>
```

## Important Implementation Details

1. **No Directory Change**: The script never uses `cd` directly. It outputs `changedir:<path>` which shell wrapper functions interpret.

2. **Shell Wrappers Required**: Users must run `wt init <shell> | source` (or `eval "$(wt init <shell>)"` for bash/zsh) to create the wrapper function that handles directory changes. The init functions are defined at wt:138-193.

3. **Worktree Placement**: New worktrees created by `wt add` are placed in the parent directory of the main repository (e.g., main at `/home/user/project` â†’ new worktree at `/home/user/feature`).

4. **Branch Logic**: The `add` command uses `git show-ref --verify --quiet` to check for existing branches/tags (local, remote, tags). If source doesn't exist, it creates a new branch with the worktree name.

5. **Porcelain Format**: All worktree parsing uses `git worktree list --porcelain` for stable output format, not the human-readable default.

6. **Error Handling**: Script uses strict mode (`set -euo pipefail` at wt:2) so any command failure or unset variable will exit. Interactive mode validates fzf is installed (wt:16-25).

## Fork-Specific Changes

This fork differs from upstream in:
- `names` subcommand is deprecated (shows warning), use `list` instead
- Running bare `wt` (no args) goes to main worktree instead of previous worktree behavior
- Completions work with spaces and special characters via proper quoting
- `add` command for creating new worktrees with intelligent branch handling
- Update functionality removed (users should manage updates via package manager)
- Shell wrappers don't create new shell instances
- Nix package configuration for easy installation

## Dependencies

**Required:**
- bash
- git
- awk, grep, sed, cut (standard Unix tools)

**Optional:**
- `fzf` - for interactive mode (`-i` flag)

**Nix Build Dependencies:**
- `makeWrapper` - for wrapping the binary with PATH
- `installShellFiles` - for installing shell completions
