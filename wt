#!/usr/bin/env bash
set -e

# Switch between git worktrees with speed.

args=("$@")
VERSION="0.2.8-fork"
TMP_PATH=$(mktemp)
BINARY_PATH=$(realpath "$0")
CHANGE_DIRECTORY_PREFIX="changedir:"


# Escape forward slash
arg=${args[0]/\//\\\/}
is_interactive=false

for arg in "${args[@]}"; do
	if [[ "$arg" == "-i" ]]; then
		if command -v fzf &> /dev/null
		then is_interactive=true
		else
			echo "Error: fzf is not installed for interactive mode"
			echo "Install from: https://github.com/junegunn/fzf#installation"
			exit 1
		fi
	break
	fi
done

worktree_list_names() {
	if git rev-parse --git-dir &> /dev/null; then
		git worktree list --porcelain \
			| awk '/^worktree / { sub("worktree ", ""); print; }' \
			| tr \\n \\0 \
			| xargs -0 -L 1 basename
	fi
}

add_worktree() {
	local worktree_name="${args[1]}"
	local source_branch="${args[2]}"
	local worktree_path
	local repo_root

	# Validate worktree name
	if [[ -z "$worktree_name" ]]; then
		echo "Error: worktree name is required" >&2
		echo "Usage: wt add <worktree-name> [source-branch]" >&2
		exit 1
	fi

	# Check git repository
	if ! git rev-parse --git-dir &> /dev/null; then
		echo "Error: not in a git repository" >&2
		exit 1
	fi

	# Determine worktree path
	repo_root=$(git rev-parse --show-toplevel)
	worktree_path="$(dirname "$repo_root")/$worktree_name"

	# Check for existing worktree/path
	if [[ -e "$worktree_path" ]]; then
		echo "Error: path already exists: $worktree_path" >&2
		exit 1
	fi

	if git worktree list --porcelain | grep -q "^worktree.*/$worktree_name$"; then
		echo "Error: worktree '$worktree_name' already exists" >&2
		exit 1
	fi

	# Use current branch if no source specified
	if [[ -z "$source_branch" ]]; then
		source_branch=$(git branch --show-current)
		if [[ -z "$source_branch" ]]; then
			echo "Error: not on any branch and no source branch specified" >&2
			exit 1
		fi
	fi

	# Check if source exists (local/remote branch or tag)
	if git show-ref --verify --quiet "refs/heads/$source_branch" || \
	   git show-ref --verify --quiet "refs/remotes/origin/$source_branch" || \
	   git show-ref --verify --quiet "refs/tags/$source_branch"; then
		# Checkout existing branch/tag
		echo "Creating worktree '$worktree_name' from existing branch/tag '$source_branch'..."
		if git worktree add "$worktree_path" "$source_branch"; then
			echo "Created worktree '$worktree_name' from existing branch/tag '$source_branch'"
		else
			echo "Error: failed to create worktree" >&2
			exit 1
		fi
	else
		# Create new branch
		echo "Creating worktree '$worktree_name' with new branch '$worktree_name'..."
		if git worktree add -b "$worktree_name" "$worktree_path" "$source_branch"; then
			echo "Created worktree '$worktree_name' with new branch '$worktree_name'"
		else
			echo "Error: failed to create worktree with new branch" >&2
			exit 1
		fi
	fi
}

help_message() {
	echo -e "wt lets you switch between your git worktrees with speed.\n"
	echo "Usage:"
	echo -e "\twt: go to the main worktree"
	echo -e "\twt <worktree-name>: search for worktree names and change to that directory."
	echo -e "\twt -i: interactively select a worktree using fzf."
	echo -e "\twt list: list out all the git worktrees."
	echo -e "\twt names: list out only the git worktree names."
	echo -e "\twt add <name> [source]: create a new worktree with optional source branch."
	echo -e "\twt version: show the CLI version."
	echo -e "\twt init <shell>: print the init script for <shell>."
	echo -e "\twt help: shows this help message."
}

get_dest_path="\$(echo \"\$result\" | awk '/^$CHANGE_DIRECTORY_PREFIX.*/ {sub(\"$CHANGE_DIRECTORY_PREFIX\", \"\"); print; exit}')"

init_bash() {
	cat <<EOF
wt() {
	result="\$($BINARY_PATH "\$@")"
	dest_path="$get_dest_path"

	if [[ -n "\$dest_path" ]]; then
		cd "\$dest_path" || return
	elif [[ -n \$result ]]; then
		echo "\$result"
	fi
}
EOF
}

init_fish() {
	cat <<EOF
function wt
	set -l result "\$($BINARY_PATH \$argv)"
	set -l dest_path "$get_dest_path"

	if test -n "\$dest_path"
		cd "\$dest_path"
	else if test -n "\$result"
		echo "\$result"
	end
end
EOF
}

init() {
	shell="${args[1]}"
	if [[ -z $shell ]]; then
		echo "Please supply a shell."
		echo "    eg. wt init bash"
		exit 1
	fi
	case "$shell" in
	bash|zsh)
		init_bash
		;;
	fish)
		init_fish
		;;
	*)
		echo "Unsupported shell: $shell"
		exit 1
		;;
	esac
}

case "${args[0]}" in
list)
	worktree_list_names
	;;
names)
	worktree_list_names
	echo -e '\033[0;31mThe '\''names'\'' option is deprecated and will be removed in future versions.\033[0m' >&2
	echo -e '\033[0;31mUse '\''list'\'' instead.\033[0m' >&2
	;;
add)
	add_worktree
	;;
help)
	help_message
	;;
version)
	echo Version: $VERSION
	;;
init)
	init
	;;
*)
	if [[ "$is_interactive" == true ]]; then
		directory=$(git worktree list --porcelain |
		awk '/worktree/ {wt=$2} /branch/ {sub("refs/heads/", "", $2); print wt " [" $2 "]"}' |
		fzf --query "" --height=10% --no-multi --exit-0 |
		awk '{print $1}')
	else
		directory=$(git worktree list --porcelain | grep -E 'worktree ' | awk '/'"$arg"'/ {print; exit}' | cut -d ' ' -f2-)
	fi

	;;
esac

# If directory variable is not empty then change worktree
if [ -z "$directory" ]; then
	:
else
	echo "$CHANGE_DIRECTORY_PREFIX$directory"
fi
